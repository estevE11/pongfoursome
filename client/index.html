<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <style>
        #messages tr td:first-child {
            text-align: end;
        }
    </style>
</head>
<body>
    <div id="connect-ui">
        <input id="username" type="text">
        <button onclick="connect()">Connect</button>
    </div>
    <div id="canvas-container" style="visibility: hidden">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
    <div>
        <table>
            <tbody id="messages">
            </tbody>
        </table>
    </div>
    <div id="input-ui" style="visibility: hidden">
        <input id="message" type="text">
        <button onclick="sendChatMessage()">Send</button>
    </div>
    <script>
        let socket;
        let username;
        let id;

        let canvas, ctx;
        let width = document.getElementById("canvas").width;
        let height = document.getElementById("canvas").height;

        let x = 0;
        let y = 0;

        const pW = 20, pH = 20;

        let online_players = [];
        
        let keys = [];

        function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            window.addEventListener('keydown', (event) => {
                keys[event.key] = true;
                console.log(event.key);
            })
            
            window.requestAnimationFrame(loop);
        }

        function loop() {
            update();
            render();
            window.requestAnimationFrame(loop);
        }

        function update() {
            x++;
            if(x + pW > width) x = width - pW;

            sendGameMessage();
        }

        function render() {
            clear(); 

            online_players.map((player) => {
                ctx.fillStyle = "white";
                ctx.fillRect(player.x, player.y, 20, 20);
            });
        }

        function clear() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, width, height);
        }

        function connect() {
            socket = new WebSocket('ws://localhost:8080/');
            console.log("Connecting...")

            socket.onopen = (event) => {
                sendConnectionMessage();
                hideConnectUI();
                showInputUI();
            }

            socket.onmessage = (event) => {
                handleMessage(event.data)
            }

            socket.onclose = (event) => {
                console.log("Disconnected")
            }

            socket.onerror = (error) => {
                console.log("Error", error)
            }
        }

        function sendConnectionMessage() {
            username = document.getElementById("username").value;
            sendMessage("connect", {
                username: username
            })
        }

        function handleMessage(data) {
            const msg = JSON.parse(data)
            handler[msg.type.toLowerCase()](msg.data);
        }

        function handleConnectMessage(data) {
            id = data.id;
            init();
        }

        function handleGameMessage(data) {
            online_players = data.players;
            const player = online_players.find(p => p.id == id)
            x = player.x;
            y = player.y;
        }

        function handleChatMessage(data) {
            addMessage(data.username, data.message);
        }

        function sendGameMessage() {
            const data = {
                id: id,
                x: x,
                y: y
            };

            sendMessage("game", data);
        }

        function sendChatMessage() {
            const message = document.getElementById('message').value;
            sendMessage("chat", {id: id, username: username, message: message});
            document.getElementById('message').value = "";
        }

        function sendMessage(type, data) {
            socket.send(JSON.stringify({type: type, data: data}));
        }

        function addMessage(username, message) {
            const td_username = document.createElement('td');
            const td_message = document.createElement('td');
            td_username.innerText = username;
            td_message.innerText = message;
            const messages = document.getElementById('messages');
            const tr = document.createElement('tr');
            tr.appendChild(td_username);
            tr.appendChild(td_message);
            messages.appendChild(tr);
        }

        function hideConnectUI() {
            document.getElementById("connect-ui").style.visibility = 'hidden';
        }

        function showInputUI() {
            document.getElementById("input-ui").style.visibility = 'visible';
            document.getElementById("canvas-container").style.visibility = 'visible';
        }

        const handler = {
            "connect": handleConnectMessage,
            "chat": handleChatMessage,
            "game": handleGameMessage
        };
    </script> 
</body>
</html>